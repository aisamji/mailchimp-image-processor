name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.ref_name }}-release
  cancel-in-progress: true

jobs:
  release-please:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.main.outputs.version }}
      tag_name: ${{ steps.main.outputs.tag_name }}
      release_created: ${{ steps.main.outputs.release_created }}

    steps:
      - name: release-please-action
        id: main
        uses: googleapis/release-please-action@v4
        with:
          release-type: python

  build-binaries:
    needs:
      - release-please

    if: ${{ needs.release-please.outputs.release_created == 'true' }}

    strategy:
      fail-fast: true
      matrix:
        include:
          - runner: ubuntu-latest
            extension: ""
          - runner: windows-latest
            extension: ".exe"
          - runner: macos-latest
            extension: ".app"
          - runner: macos-latest-large
            extension: ".app"

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Install uv
        uses: threeal/pipx-install-action@v1
        with:
          packages: uv
      - name: Prepare VirtualEnv cache
        id: pycache
        uses: actions/cache@v5
        with:
          key: python-${{ hashFiles('.python-version') }}-venv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            python-${{ hashFiles('.python-version') }}-venv-
          path: .venv
      - name: Install dependencies into VirtualEnv
        if: steps.pycache.outputs.cache-hit != 'true'
        run: uv sync --frozen --no-dev

      - name: Build Binary
        run: uv run pyinstaller --onefile --windowed launcher.py
      - name: Archive Binary (*nix)
        if: ${{ runner.os != 'Windows' }}
        working-directory: dist
        run: zip -r mailchimp-image-processor-${{ needs.release-please.outputs.version }}-${{ runner.os }}-${{ runner.arch }}.zip launcher${{ matrix.extension }} 
      - name: Archive binary (Windows)
        working-directory: dist
        if: ${{ runner.os == 'Windows' }}
        run: Compress-Archive -Path launcher${{ matrix.extension }} -DestinationPath mailchimp-image-processor-${{ needs.release-please.outputs.version }}-${{ runner.os }}-${{ runner.arch }}.zip
      - name: Export Binary
        uses: actions/upload-artifact@v6
        with:
          path: dist/mailchimp-image-processor-*
          name: binary-${{ runner.os }}-${{ runner.arch }}

  upload-binaries:
    needs:
      - release-please
      - build-binaries

    if: ${{ needs.release-please.outputs.release_created == 'true' }}

    runs-on: ubuntu-latest

    steps:
      - name: Download Binaries
        uses: actions/download-artifact@v6
        with:
          path: dist
          merge-multiple: true
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          omitNameDuringUpdates: true
          tag: ${{ needs.release-please.outputs.tag_name }}
          omitBodyDuringUpdate: true
          artifacts: dist/*
          artifactErrorsFailBuild: true
          replacesArtifacts: true
